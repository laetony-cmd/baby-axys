<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Axis - ICI Dordogne</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #8B1538; --bg: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        .header { background: var(--primary); color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .header img { height: 40px; }
        .header h1 { font-size: 18px; }
        .status-dot { width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; margin-left: auto; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .bien-info { background: white; padding: 12px 15px; border-bottom: 1px solid #ddd; }
        .bien-card { display: flex; gap: 12px; align-items: center; }
        .bien-logo { width: 60px; height: 60px; border-radius: 8px; object-fit: contain; flex-shrink: 0; }
        .bien-details { display: flex; flex-direction: column; gap: 2px; }
        .bien-details strong { color: var(--primary); font-size: 15px; }
        .bien-details span { font-size: 13px; color: #666; }
        .site-link { font-size: 13px; color: var(--primary); text-decoration: none; margin-top: 4px; font-weight: 500; }
        .site-link:hover { text-decoration: underline; }
        .site-link.hidden { display: none; }
        .chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 15px; white-space: pre-wrap; }
        .msg.assistant { background: white; align-self: flex-start; border: 1px solid #ddd; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; }
        .input-area { background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 15px; }
        .input-area input:focus { outline: none; border-color: var(--primary); }
        .input-area button { background: var(--primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 20px; }
        .typing { display: none; padding: 12px 16px; background: white; border-radius: 18px; align-self: flex-start; }
        .typing.active { display: block; }
        .typing span { display: inline-block; width: 8px; height: 8px; background: #999; border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://www.icidordogne.fr/files/2021/03/cropped-Logo-haut-270x270.jpg" alt="ICI Dordogne">
        <div><h1>Axis</h1><p style="font-size:12px;opacity:0.9">Assistant ICI Dordogne</p></div>
        <div class="status-dot"></div>
    </div>
    
    <div class="bien-info">
        <div class="bien-card">
            <img src="https://www.icidordogne.fr/files/2021/03/cropped-Logo-haut-270x270.jpg" alt="ICI Dordogne" class="bien-logo">
            <div class="bien-details">
                <strong>__BIEN_TITRE__</strong>
                <span>üìç __BIEN_COMMUNE__ ‚Ä¢ __BIEN_PRIX__</span>
                <a href="__SITE_URL__" target="_blank" class="site-link __SITE_HIDDEN__">üì∏ Voir les photos du bien ‚ûú</a>
            </div>
        </div>
    </div>
    
    <div class="chat" id="chat"></div>
    <div class="typing" id="typing"><span></span><span></span><span></span></div>
    
    <div class="input-area">
        <input type="text" id="input" placeholder="Votre message..." autocomplete="off">
        <button onclick="sendMessage()">‚û§</button>
    </div>

    <script>
        // Variables inject√©es par Python
        const TOKEN = "__TOKEN__";
        const BIEN_TITRE = "__BIEN_TITRE__";
        const BIEN_COMMUNE = "__BIEN_COMMUNE__";
        const BIEN_PRIX = "__BIEN_PRIX__";
        const PRENOM = "__PRENOM__";
        const BIEN_IDENTIFIE = __BIEN_IDENTIFIE__;
        const MATCH_SCORE = __MATCH_SCORE__;
        
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const typing = document.getElementById('typing');
        
        // Message d'accueil PERSONNALIS√â selon le score
        let MSG_ACCUEIL;
        
        if (BIEN_IDENTIFIE && MATCH_SCORE >= 90) {
            // GOLDEN TICKET - Match certain
            MSG_ACCUEIL = `Bonjour${PRENOM ? ' ' + PRENOM : ''} ! üéâ

Excellente nouvelle : j'ai trouv√© **le bien qui correspond √† votre recherche** !

üè† ${BIEN_TITRE}${BIEN_COMMUNE ? ' √† ' + BIEN_COMMUNE : ''}${BIEN_PRIX ? '\nüí∞ ' + BIEN_PRIX : ''}

Ce bien est disponible et je peux vous organiser une visite tr√®s rapidement.

**Souhaitez-vous :**
‚Ä¢ Recevoir plus de photos ?
‚Ä¢ Organiser une visite ?
‚Ä¢ En savoir plus sur ce bien ?`;
        } else if (BIEN_IDENTIFIE) {
            // Match partiel - besoin de confirmer
            MSG_ACCUEIL = `Bonjour${PRENOM ? ' ' + PRENOM : ''} ! üëã

Merci pour votre demande ! J'ai identifi√© un bien qui pourrait correspondre :

üè† ${BIEN_TITRE}${BIEN_COMMUNE ? ' √† ' + BIEN_COMMUNE : ''}${BIEN_PRIX ? '\nüí∞ ' + BIEN_PRIX : ''}

Pour vous proposer exactement ce qui vous convient, j'aurais quelques questions :

‚Ä¢ Quel est votre budget maximum ?
‚Ä¢ Combien de chambres minimum ?
‚Ä¢ Quelle surface habitable recherchez-vous ?`;
        } else {
            // Pas de match - qualification n√©cessaire
            MSG_ACCUEIL = `Bonjour${PRENOM ? ' ' + PRENOM : ''} ! üëã

Merci de votre int√©r√™t pour nos biens${BIEN_COMMUNE ? ' dans le secteur de ' + BIEN_COMMUNE : ''} !

Je suis Axis, votre assistant ICI Dordogne. Je vais vous aider √† trouver le bien id√©al.

Pour affiner ma recherche, pourriez-vous me pr√©ciser :
‚Ä¢ Votre budget ?
‚Ä¢ La surface souhait√©e ?
‚Ä¢ Le nombre de chambres ?

üá´üá∑ Je parle fran√ßais | üá¨üáß English | üá≥üá± Nederlands | üá©üá™ Deutsch`;
        }
        
        // Message de re-bienvenue pour les retours
        const MSG_REBIENVENUE = `Re-bonjour${PRENOM ? ' ' + PRENOM : ''} ! üëã

Je vois que vous revenez sur le dossier **${BIEN_TITRE}**${BIEN_COMMUNE ? ' √† ' + BIEN_COMMUNE : ''}${BIEN_PRIX ? ' (' + BIEN_PRIX + ')' : ''}.

Je suis √† votre disposition. Comment puis-je vous aider ?`;
        
        // ========== OPTIMISTIC UI - AFFICHAGE IMM√âDIAT ==========
        // √âtape 1: Afficher le message d'accueil IMM√âDIATEMENT (0.1s)
        addMessage('assistant', MSG_ACCUEIL);
        
        // √âtape 2: Charger l'historique en arri√®re-plan
        fetch('/api/prospect-chat/history?token=' + TOKEN)
            .then(r => r.json())
            .then(data => {
                const messages = data.messages || [];
                const hasUserMessage = messages.some(m => m.role === 'user');
                
                if (messages.length === 0) {
                    // Prospect vierge - sauvegarder le message affich√©
                    saveFirstMessage(MSG_ACCUEIL);
                    
                } else if (hasUserMessage) {
                    // Conversation engag√©e - REMPLACER par l'historique complet
                    chat.innerHTML = ''; // Vider le chat
                    messages.forEach(m => addMessage(m.role, m.content));
                    addMessage('assistant', MSG_REBIENVENUE);
                    appendMessage('assistant', MSG_REBIENVENUE);
                }
                // Si pas de user message, on garde le MSG_ACCUEIL d√©j√† affich√©
            })
            .catch(e => {
                console.error("Erreur historique:", e);
                // MSG_ACCUEIL d√©j√† affich√©, on continue
            });
        
        // Sauvegarder le premier message
        function saveFirstMessage(content) {
            fetch('/api/prospect-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: TOKEN, role: 'assistant', content: content, action: 'init'})
            }).catch(e => console.error("Erreur save:", e));
        }
        
        // Mettre √† jour le premier message (√©crasement)
        function updateFirstMessage(content) {
            fetch('/api/prospect-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: TOKEN, role: 'assistant', content: content, action: 'update_first'})
            }).catch(e => console.error("Erreur update:", e));
        }
        
        // Ajouter un message √† l'historique
        function appendMessage(role, content) {
            fetch('/api/prospect-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: TOKEN, role: role, content: content, action: 'append'})
            }).catch(e => console.error("Erreur append:", e));
        }
            .catch(e => console.error("Erreur historique:", e));
        
        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = 'msg ' + role;
            div.textContent = content;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        
        async function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;
            
            addMessage('user', msg);
            input.value = '';
            typing.classList.add('active');
            
            try {
                const resp = await fetch('/api/prospect-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({token: TOKEN, message: msg})
                });
                
                const data = await resp.json();
                typing.classList.remove('active');
                
                if (data.response) {
                    addMessage('assistant', data.response);
                }
            } catch(e) {
                typing.classList.remove('active');
                addMessage('assistant', 'D√©sol√©, une erreur technique est survenue.');
                console.error(e);
            }
        }
        
        input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
<!-- FIX 28/12/2025 - Hollandais ajout√© -->
